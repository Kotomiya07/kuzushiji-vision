# 本文モデルからふりがなモデルへの転移学習計画

## 1. 目的

くずし字の本文文字認識モデルで学習済みの重みを活用し、ふりがな文字認識モデルの学習を効率化・高精度化する。

## 2. 方針

現在の実装に基づき、最終分類層以外の重みを転移させる方針で進める。

## 3. 詳細計画

### 3.1. 辞書

*   **使用する辞書:** 現在の実装通り、データセット内の全文字（本文・ふりがな区別なし）をUnicode文字列の辞書順でソートしてIDを割り当てた辞書を使用する。
    *   例: `data/column_dataset/unicode_to_id.json`, `data/column_dataset/id_to_unicode.json`
*   **理由:** 実装調査の結果、転移学習時に最終分類層はクラス数に応じて再初期化される可能性が高いため、辞書順序の変更によるメリットは限定的と判断。既存の実装を維持することで、複雑化を避ける。

### 3.2. モデル

*   **使用するモデル:** `models.character_detection.model.CharacterDetectionModel`
    *   Vision Transformer バックボーン + 検出ヘッド + 分類ヘッド の構成。

### 3.3. 転移学習プロセス

1.  **学習済み重みの準備:**
    *   本文文字認識タスクで学習させたモデルのチェックポイントファイル（例: `experiments/character_detection/best_model.pth` など）を用意する。
2.  **設定ファイルの準備:**
    *   ふりがな文字認識モデル用の設定ファイル（例: `config/model/furigana_detection.yaml`）を作成または編集する。
    *   データセットのパスをふりがな用に変更する。
    *   `training.resume_from_checkpoint` パラメータに、上記で用意した本文モデルのチェックポイントファイルのパスを指定する。
3.  **学習スクリプトの実行:**
    *   `trainer/train_character_detection.py` を、ふりがな用の設定ファイルを用いて実行する。
4.  **重みロードの確認 (推奨):**
    *   学習開始時のログを確認し、`accelerator.load_state` がチェックポイントをロードしたこと、特に最終分類層 (`classification_head.6.weight` など) のサイズ不一致に関する警告（もしあれば）や、他の層の重みがロードされたことを確認する。

### 3.4. 学習

*   ふりがなデータセットを用いて、転移された重みからモデルの学習を開始する。
*   オプティマイザや学習率スケジューラは、ふりがなタスク用に設定ファイルで指定されたものを使用する。

### 3.5. 評価

*   学習中の検証データセットに対する mAP (Mean Average Precision) や文字認識精度 (Character Accuracy) を監視する。
*   学習完了後、テストデータセットを用いて最終的なモデル性能を評価する。

## 4. 期待される効果

*   バックボーンが学習済みの特徴抽出能力を持つため、学習の収束が早まる。
*   より少ないデータでも、比較的高い精度を達成できる可能性がある。

## 5. 次のステップ

*   上記計画に基づき、ふりがなモデルの学習設定を行い、学習を実行する。
